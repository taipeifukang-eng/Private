# 使用者角色指派功能使用指南

## 功能概述

本功能允許系統管理員將角色指派給使用者，實現細粒度的權限控制。

## 功能特色

### 1. 使用者搜尋
- 支援多種搜尋方式：Email、姓名、員工編號
- 即時搜尋（輸入 2 個字元後自動搜尋）
- 顯示使用者詳細資訊

### 2. 角色指派
- 為使用者指派角色
- 可設定角色到期日（選填）
- 防止重複指派
- 完整的權限檢查

### 3. 使用者管理
- 查看所有擁有該角色的使用者
- 顯示使用者狀態（啟用/停用）
- 顯示指派日期和到期日
- 可隨時移除使用者的角色

## 使用步驟

### 指派角色給使用者

1. **進入角色編輯頁面**
   - 導航至 `/admin/roles`
   - 點擊要管理的角色的「編輯」按鈕

2. **切換至使用者管理分頁**
   - 在角色編輯頁面，點擊「使用者管理」分頁

3. **新增使用者**
   - 點擊右上角的「+ 新增使用者」按鈕
   - 在搜尋框中輸入 Email、姓名或員工編號（至少 2 個字元）
   - 從搜尋結果中選擇要指派的使用者
   - （選填）設定角色到期日
   - 點擊「指派角色」按鈕

4. **確認指派**
   - 系統會顯示「使用者已指派角色」的提示
   - 使用者列表會自動更新

### 移除使用者角色

1. 在「使用者管理」分頁的使用者列表中
2. 找到要移除的使用者
3. 點擊該使用者列的「移除」按鈕
4. 確認移除操作
5. 系統會顯示「使用者角色已移除」的提示

## API 端點

### 1. 搜尋使用者
```
GET /api/users/search?q={查詢字串}
```

**查詢參數：**
- `q`: 搜尋關鍵字（Email、姓名或員工編號）

**回應範例：**
```json
{
  "users": [
    {
      "id": "uuid",
      "email": "user@example.com",
      "name": "使用者姓名",
      "employee_code": "EMP001"
    }
  ]
}
```

### 2. 取得角色的使用者列表
```
GET /api/roles/{roleId}/users
```

**權限要求：** `role.user_role.view`

**回應範例：**
```json
{
  "users": [
    {
      "id": "uuid",
      "email": "user@example.com",
      "name": "使用者姓名",
      "employee_code": "EMP001",
      "is_active": true,
      "assigned_at": "2024-01-01T00:00:00Z",
      "expires_at": "2024-12-31T23:59:59Z"
    }
  ]
}
```

### 3. 指派角色給使用者
```
POST /api/roles/{roleId}/users
```

**權限要求：** `role.user_role.assign`

**請求 Body：**
```json
{
  "user_id": "uuid",
  "expires_at": "2024-12-31" // 選填
}
```

**回應範例：**
```json
{
  "message": "使用者角色已指派",
  "user_role": {
    "id": "uuid",
    "user_id": "uuid",
    "role_id": "uuid",
    "assigned_at": "2024-01-01T00:00:00Z",
    "expires_at": "2024-12-31T23:59:59Z"
  }
}
```

### 4. 移除使用者角色
```
DELETE /api/roles/{roleId}/users/{userId}
```

**權限要求：** `role.user_role.revoke`

**回應範例：**
```json
{
  "message": "使用者角色已移除"
}
```

## 資料庫結構

### user_roles 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| user_id | UUID | 使用者 ID（關聯 auth.users） |
| role_id | UUID | 角色 ID（關聯 roles） |
| assigned_by | UUID | 指派者 ID（關聯 auth.users） |
| assigned_at | TIMESTAMP | 指派時間 |
| expires_at | TIMESTAMP | 到期時間（可為 NULL） |
| is_active | BOOLEAN | 是否啟用 |

### 唯一性約束
- `(user_id, role_id)` 組合必須唯一，防止重複指派

## 權限說明

### 必要權限

1. **查看使用者角色**
   - 權限代碼：`role.user_role.view`
   - 說明：查看角色的使用者列表

2. **指派使用者角色**
   - 權限代碼：`role.user_role.assign`
   - 說明：為使用者指派角色

3. **撤銷使用者角色**
   - 權限代碼：`role.user_role.revoke`
   - 說明：移除使用者的角色

### 權限檢查流程

1. 使用者訪問角色編輯頁面時，檢查是否有 `role.role.view` 權限
2. 點擊「使用者管理」分頁時，檢查是否有 `role.user_role.view` 權限
3. 新增使用者時，檢查是否有 `role.user_role.assign` 權限
4. 移除使用者時，檢查是否有 `role.user_role.revoke` 權限

## 使用場景範例

### 場景 1：為新進員工指派角色

1. HR 進入系統管理介面
2. 選擇「成員 (member)」角色
3. 切換至「使用者管理」分頁
4. 搜尋新進員工的 Email
5. 指派角色（不設到期日）
6. 員工立即獲得該角色的所有權限

### 場景 2：指派臨時權限

1. 管理員需要給某員工 3 個月的臨時主管權限
2. 選擇「主管 (supervisor_role)」角色
3. 搜尋該員工
4. 設定到期日為 3 個月後
5. 指派角色
6. 到期後，該員工會自動失去主管權限

### 場景 3：權限異動

1. 員工離職或調職
2. 進入該員工原本的角色管理頁面
3. 在使用者列表中找到該員工
4. 點擊「移除」按鈕
5. 該員工立即失去該角色的所有權限

## 注意事項

1. **搜尋效能**
   - 搜尋至少需要 2 個字元
   - 使用 ILIKE 進行模糊搜尋，支援部分匹配
   - 最多返回 20 筆搜尋結果

2. **重複指派**
   - 系統會防止重複指派（同一使用者同一角色）
   - 如需更新到期日，請先移除再重新指派

3. **角色到期**
   - 到期日為選填，不填表示永久有效
   - 系統會檢查 `expires_at` 和 `is_active` 欄位來判斷角色是否有效
   - 到期的角色不會自動刪除，只是標記為無效

4. **權限即時生效**
   - 指派或移除角色後，權限會立即生效
   - 使用者可能需要重新登入或重新整理頁面才能看到變化

5. **安全性**
   - 所有 API 都有權限檢查
   - RLS (Row Level Security) 確保資料安全
   - 操作會記錄在 permission_logs 表中（如果啟用）

## 測試建議

### 測試案例 1：基本指派流程
1. 搜尋使用者
2. 指派角色
3. 確認使用者列表顯示新增的使用者
4. 確認使用者獲得相應權限

### 測試案例 2：到期日功能
1. 指派角色並設定到期日為明天
2. 確認使用者列表顯示到期日
3. 等待到期後，確認使用者失去權限

### 測試案例 3：移除角色
1. 選擇已指派角色的使用者
2. 點擊移除按鈕
3. 確認使用者從列表中消失
4. 確認使用者失去相應權限

### 測試案例 4：權限控制
1. 使用沒有 `role.user_role.assign` 權限的帳號
2. 嘗試指派角色
3. 確認操作被拒絕

### 測試案例 5：重複指派
1. 為使用者指派角色 A
2. 再次為同一使用者指派角色 A
3. 確認系統提示「該使用者已擁有此角色」

## 故障排除

### 問題 1：無法搜尋到使用者
**可能原因：**
- 搜尋關鍵字少於 2 個字元
- 使用者尚未在 profiles 表中建立資料

**解決方法：**
- 確保輸入至少 2 個字元
- 檢查 profiles 表是否有該使用者的資料

### 問題 2：指派角色失敗
**可能原因：**
- 沒有 `role.user_role.assign` 權限
- 使用者已擁有該角色
- 角色不存在

**解決方法：**
- 檢查當前使用者的權限
- 確認是否重複指派
- 確認角色 ID 是否正確

### 問題 3：使用者列表載入失敗
**可能原因：**
- 沒有 `role.user_role.view` 權限
- API 端點錯誤
- 網路問題

**解決方法：**
- 檢查瀏覽器 Console 的錯誤訊息
- 確認 API 端點是否正確
- 檢查網路連線

## 未來增強功能

1. **批次指派**
   - 支援一次為多個使用者指派相同角色
   - CSV 檔案匯入功能

2. **角色繼承**
   - 支援角色階層結構
   - 子角色自動繼承父角色的權限

3. **指派歷史**
   - 記錄所有指派/移除操作
   - 提供審計追蹤

4. **通知機制**
   - 角色指派時發送 Email 通知
   - 角色即將到期時發送提醒

5. **進階篩選**
   - 依照指派日期篩選
   - 依照到期日篩選
   - 依照使用者狀態篩選

## 相關文件

- [RBAC 系統設計文件](./RBAC_SYSTEM_DESIGN.md)
- [權限分析文件](./PERMISSION_ANALYSIS.md)
- [權限系統指南](./PERMISSION_SYSTEM_GUIDE.md)
