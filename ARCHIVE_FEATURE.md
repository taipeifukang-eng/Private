# 任務封存功能說明

## 概述

任務封存功能允許管理員和主管封存已完成的任務，以保留歷史記錄並減少活躍任務列表的混亂。

## 功能特點

### 1. 封存已完成任務
- **位置**: 任務管理頁面 (`/admin/templates`)
- **觸發**: 點擊任務卡片右上角的三點菜單，選擇"完成並封存"
- **條件**: 只有當所有任務都已完成時，此選項才會顯示
- **效果**: 
  - 將所有已完成的任務標記為已封存
  - 記錄封存時間和封存者
  - 從活躍任務列表中移除

### 2. 查看已封存任務
- **位置**: 導航欄 > 已封存任務 (`/admin/archived`)
- **權限**: 僅管理員和主管可見
- **顯示內容**:
  - 任務名稱和描述
  - 負責人和發起人
  - 協作者列表
  - 建立日期、完成日期、封存日期
  - 封存者資訊
  - 部門資訊
  - 步驟完成度
  - 查看詳細記錄按鈕

### 3. 權限控制
- **管理員**: 可以查看所有已封存的任務
- **主管**: 只能查看自己創建的任務的封存記錄
- **成員**: 無法訪問封存頁面

## 資料庫結構

### assignments 表新增欄位
```sql
archived BOOLEAN DEFAULT FALSE        -- 是否已封存
archived_at TIMESTAMPTZ               -- 封存時間
archived_by UUID                      -- 封存者 ID (references auth.users)
```

### 索引
- `idx_assignments_archived` - 提升查詢已封存任務的效率
- `idx_assignments_archived_at` - 提升按封存時間排序的效率

## API 函數

### archiveAssignment(assignmentId: string)
封存指定的任務

**參數**:
- `assignmentId`: 要封存的任務 ID

**返回**:
```typescript
{
  success: boolean;
  error?: string;
}
```

**驗證**:
- 用戶必須登入
- 用戶必須是管理員或主管
- 任務必須存在
- 任務必須已完成 (status = 'completed')
- 任務不能已經被封存

### getArchivedAssignments()
獲取已封存的任務列表

**返回**:
```typescript
{
  success: boolean;
  error?: string;
  data?: Assignment[];
}
```

**權限**:
- 管理員: 返回所有已封存的任務
- 主管: 只返回自己創建的模板的已封存任務

**包含資料**:
- 任務基本資訊
- 關聯的模板資訊
- 負責人資訊
- 創建者資訊
- 封存者資訊
- 協作者列表
- 操作日誌

## 使用流程

1. **創建並派發任務**
   - 主管/管理員創建任務模板
   - 指派任務給團隊成員

2. **完成任務**
   - 團隊成員執行並完成所有步驟
   - 任務狀態變為 "已完成"

3. **封存任務**
   - 主管/管理員在任務管理頁面找到該任務
   - 點擊三點菜單
   - 選擇"完成並封存"
   - 確認封存操作

4. **查看歷史記錄**
   - 前往"已封存任務"頁面
   - 查看所有已封存的任務
   - 點擊"查看詳細記錄"查看完整的執行歷史

## 注意事項

- 已封存的任務不會出現在"我的任務"頁面
- 已封存的任務不會計入任務管理頁面的統計數據
- 已封存的任務無法恢復到活躍狀態（可以通過資料庫手動修改）
- 建議定期查看已封存任務，確保重要記錄已妥善保存

## 遷移指南

如果您已經有現有的資料庫，請執行以下遷移 SQL:

```sql
-- 執行 supabase/migration_add_archived.sql
\i supabase/migration_add_archived.sql
```

或在 Supabase Dashboard 的 SQL Editor 中運行 `migration_add_archived.sql` 的內容。

## 未來改進建議

1. 添加恢復已封存任務的功能
2. 添加批量封存功能
3. 添加封存任務的搜索和篩選功能
4. 添加自動封存策略（例如：完成後 30 天自動封存）
5. 添加匯出已封存任務為 PDF/Excel 的功能
