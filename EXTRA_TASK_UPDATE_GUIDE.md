# 額外任務功能更新說明

## 更新日期
2026-01-29

## 更新內容

### 1. 自動計算「該店規劃實上時數」

修改點選額外任務（長照外務/診所業務）時的邏輯：

#### 計算規則
當選擇「長照外務」或「診所業務」時，系統會自動計算「該店規劃實上時數」：

1. **正職整月任職** → 160小時
2. **督導(代理店長)-雙** → 使用「本月上班時數」欄位的值
3. **本月工作天數不滿** → 使用公式計算：`工作天數 / 5 × 32`

#### 介面變更
- 「該店規劃實上時數」欄位改為**唯讀**，顯示「自動計算」
- 「外務時數」欄位維持**可編輯**
- 兩個欄位皆會在資料匯出時匯出

### 2. 資料匯出增加欄位

在資料匯出（下載 Excel）功能中新增：
- **K欄：外務時數** - 顯示員工的外務時數

#### Excel 欄位順序
| 欄位 | 內容 | 說明 |
|------|------|------|
| A | 門市代碼 | |
| B | 月份 | |
| C | 員工代號 | |
| D | 員工姓名 | |
| E | 計算區塊 | |
| F | 職位 | |
| G | 階段 | |
| H | 當月個人實際毛利 | |
| I | 時數 | 優先使用「該店規劃實上時數」 |
| J | 天數(含休假) | |
| K | 外務時數 | **新增** |

### 3. 區塊4判斷維持不變

點選額外任務（長照外務/診所業務）的人員仍會被歸類到**區塊4**，此邏輯不變。

## 修改的檔案

### 前端檔案
1. `app/monthly-status/edit/[id]/page.tsx`
   - 新增 `useEffect` 監聽額外任務和相關欄位變化
   - 自動計算「該店規劃實上時數」
   - 修改欄位為唯讀狀態

2. `app/monthly-status/page.tsx`
   - 新增頁面也加入相同的自動計算邏輯
   - 修改欄位為唯讀狀態

### 後端檔案
3. `app/api/export-monthly-status/download/route.ts`
   - 在 Excel 資料中新增「外務時數」欄位
   - 更新欄寬設定以包含新欄位

## 資料庫結構

現有欄位（無需修改）：
- `extra_task_planned_hours` - 該店規劃實上時數
- `extra_task_external_hours` - 外務時數

這些欄位已在之前的遷移腳本中建立：
- `supabase/migration_add_extra_task_hours.sql`

## 測試項目

### 1. 自動計算測試

#### 測試案例 1：正職整月
- 選擇「長照外務」或「診所業務」
- 職務：專員（非督導代理店長雙）
- 本月狀態：整月在職
- **預期結果**：該店規劃實上時數 = 160

#### 測試案例 2：督導(代理店長)-雙
- 選擇「長照外務」或「診所業務」
- 職務：督導(代理店長)-雙
- 本月上班時數：120
- **預期結果**：該店規劃實上時數 = 120

#### 測試案例 3：工作天數不滿
- 選擇「長照外務」或「診所業務」
- 職務：專員
- 本月狀態：非整月（如到職、離職等）
- 工作天數：15天
- **預期結果**：該店規劃實上時數 = 15 / 5 × 32 = 96

### 2. 資料匯出測試

1. 建立測試資料：
   - 至少一位有外務時數的員工
   - 至少一位沒有外務時數的員工

2. 執行資料匯出

3. 檢查 Excel 檔案：
   - K欄「外務時數」是否存在
   - 有外務的員工，K欄顯示正確數值
   - 沒有外務的員工，K欄為空白

### 3. 編輯頁面測試

1. 開啟人員狀態編輯頁面
2. 勾選「長照外務」或「診所業務」
3. 確認「該店規劃實上時數」欄位：
   - 顯示為唯讀（灰色背景）
   - 顯示正確的自動計算值
   - 無法手動修改

4. 確認「外務時數」欄位：
   - 可以正常編輯
   - 可以輸入數值

## 相關文件

- `MONTHLY_STATUS_GUIDE.md` - 每月人員狀態系統指南
- `migration_add_extra_task_hours.sql` - 外務時數欄位遷移腳本
- `migration_extra_task_block4.sql` - 額外任務區塊4邏輯

## 注意事項

1. **該店規劃實上時數**為自動計算，無法手動修改
2. **外務時數**需由使用者手動填入
3. 資料庫中兩個欄位都會保存，確保資料完整性
4. Excel 匯出時，「時數」欄位會優先顯示「該店規劃實上時數」（如果有的話）
5. 有選擇額外任務的員工仍會被歸類到區塊4
