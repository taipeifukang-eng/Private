# 支援人員單品獎金管理指南

## 功能概述
支援人員單品獎金管理功能允許店長及以上權限的使用者批次管理上個月支援人員的單品獎金。

## 權限要求
- 管理員（admin）
- 經理（manager）
- 督導（supervisor）
- 區域經理（area_manager）
- 店長職位：店長、代理店長、督導、督導(代理店長)

## 功能位置
**每月人員狀態確認頁面 → 支援人員獎金按鈕**

在每個門市的操作按鈕區域（手動新增員工、誤餐費登記旁邊）會看到「支援人員獎金」按鈕。

## 使用步驟

### 1. 資料庫遷移
首先需要在 Supabase SQL Editor 執行遷移腳本：
```bash
supabase/migration_support_staff_bonus.sql
```

### 2. 開啟支援人員獎金視窗
1. 進入「每月人員狀態確認」頁面
2. 在任一門市的操作區域點擊「支援人員獎金」按鈕（紫色按鈕）
3. 彈出支援人員單品獎金管理視窗

### 3. 批次輸入獎金

#### 方法一：手動輸入
1. 點擊「新增一列」按鈕
2. 在員編欄位輸入或搜尋員工
   - 輸入員編或姓名會顯示下拉選單
   - 點擊選擇員工後會自動帶入姓名
3. 輸入獎金金額
4. 繼續點擊「新增一列」可輸入更多員工
5. 完成後點擊「儲存獎金資料」

#### 方法二：Excel 匯入
1. 點擊「匯入 Excel」
2. 選擇包含以下欄位的 Excel 檔案：
   - 員編（必填）
   - 姓名（必填）
   - 單品獎金（必填，數字）
3. 系統會自動載入資料到表格
4. 確認無誤後點擊「儲存獎金資料」

### 4. 編輯現有資料
1. 開啟支援人員獎金視窗
2. 系統會自動載入當月的獎金資料
3. 直接修改金額、新增或刪除列
4. 點擊「儲存獎金資料」更新

### 5. 資料匯出
支援人員的單品獎金會自動包含在每月人員狀態的單品獎金匯出中：

1. 進入「每月人員狀態 → 資料匯出」
2. 選擇年月和門市
3. 點擊「匯出單品獎金」
4. Excel 檔案會包含：
   - 各門市員工的單品獎金（從 monthly_staff_status）
   - 支援人員的單品獎金（從 support_staff_bonus，門市代號欄位為空）

## Excel 格式說明

### 匯入格式
| 員編 | 姓名 | 單品獎金 |
|------|------|----------|
| FK001 | 張三 | 5000 |
| FK002 | 李四 | 3500 |

### 匯出格式
| 門市代號 | 月份 | 員編 | 姓名 | 單品獎金總額 |
|----------|------|------|------|--------------|
| FKA01 | 2024-11 | FK001 | 張三 | 8000 |
| FKA01 | 2024-11 | FK002 | 李四 | 6500 |
| | 2024-11 | FK003 | 王五 | 5000 |

*註：門市代號為空的列代表支援人員*

## 資料庫結構

### support_staff_bonus 表格
```sql
- id: uuid (主鍵)
- year_month: varchar(7) - 格式：YYYY-MM
- employee_code: varchar(50) - 員工編號
- employee_name: varchar(100) - 員工姓名
- bonus_amount: decimal(10,2) - 獎金金額
- created_at: timestamptz
- updated_at: timestamptz
- created_by: uuid (外鍵至 auth.users)

唯一約束：(employee_code, year_month)
```

## 注意事項

1. **月份同步**：支援人員獎金視窗會使用當前選擇的年月（每月人員狀態確認頁面的年月選擇器）
2. **唯一性**：同一員工在同一月份只能有一筆獎金記錄
3. **覆蓋儲存**：儲存時會覆蓋該月份的所有資料
4. **員工搜尋**：
   - 搜尋框會即時篩選員工清單
   - 最多顯示 50 筆符合結果
   - 支援員編和姓名搜尋
   - 點擊員工後會自動帶入完整資料
5. **金額格式**：支援小數點，最多兩位小數（例如：5000.50）
6. **自動計算**：視窗右上角會顯示所有獎金的總和
7. **權限檢查**：只有店長以上權限才會看到「支援人員獎金」按鈕

## 權限說明

### RLS 政策
- **查詢**：店長以上權限可查看所有支援人員獎金
- **新增/修改/刪除**：店長以上權限可管理支援人員獎金
- **created_by**：自動記錄建立者的 user_id

### 檢查方式
系統會檢查以下條件（滿足任一即可）：
1. 使用者角色為 admin、manager、supervisor、area_manager
2. 使用者職位為店長、代理店長、督導、督導(代理店長)

## 測試檢查清單
看到「支援人員獎金」按鈕（紫色）
- [ ] 非店長看不到「支援人員獎金」按鈕
- [ ] 點擊按鈕可以開啟支援人員獎金視窗
- [ ] 視窗顯示當前選擇的年月
- [ ] 可以手動輸入員編
- [ ] 員工搜尋功能正常（輸入時顯示下拉選單）
- [ ] 選擇員工後自動帶入姓名
- [ ] 可以新增多列
- [ ] 可以刪除列
- [ ] 儲存功能正常
- [ ] 載入時顯示該月的現有獎金資料
- [ ] Excel 匯入功能正常
- [ ] Excel 匯出功能正常
- [ ] 總計金額計算正確
- [ ] 同一員工同一月份無法重複新增（儲存時檢查）
- [ ] 資料匯出包含支援人員獎金（門市代號為空）含支援人員獎金）
- [ 查詢支援人員獎金
- **URL**: `/api/support-bonus`
- **Method**: GET
- **Query Params**: `year_month=2024-11`
- **Response**:
  ```json
  {
    "success": true,
    "records": [
      {
        "id": "uuid",
        "employee_code": "FK001",
        "employee_name": "張三",
        "bonus_amount": 5000,
        "year_month": "2024-11"
      }
    ]
  }
  ```

### ] 總計金額計算正確
- [ ] 同一員工同一月份無法重複新增

## API 端點

### 儲存支援人員獎金
- **URL**: `/api/support-bonus/save`
- **Method**: POST
- **Body**:
  ```json
  {
    "year_month": "2024-11",
    "bonuses": [
      {
        "employee_code": "FK001",
        "employee_name": "張三",
        "bonus_amount": 5000
      }
    看不到「支援人員獎金」按鈕
- 確認使用者是否為店長以上權限
- 檢查資料庫中的 job_title 或 role 欄位是否正確
- 確認在每月人員狀態確認頁面（不是其他頁面）
- **Response**:
  ```json
  {
    "success": true,
    "count": 1
  }
  ```

### 匯出單品獎金（包含支援人員）
- **URL**: `/api/export-monthly-status/single-item-bonus`
- **Method**: POST
- **Body**:
  ```json
  {
    "year_month": "2024-11",
    "store_ids": ["uuid1", "uuid2"]
  }
  ```
- **Response**: Excel 檔案

## 問題排解

### 無法進入頁面
- 確認使用者是否為店長以上權限
- 檢查資料庫中的 job_title 欄位是否正確

### 儲存失敗
- 確認員編和姓名都有填寫
- 確認獎金金額為有效數字
- 檢查是否有權限問題

### 匯出沒有支援人員資料
- 確認該月份是否有支援人員獎金資料
- 檢查 support_staff_bonus 表格的 year_month 格式是否正確

### 員工搜尋沒有結果
- 確認員工管理中是否有該員工
- 確認 store_employees 表格是否有資料
- 嘗試使用完整員編或完整姓名搜尋
