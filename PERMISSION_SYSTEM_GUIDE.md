# ç³»çµ±æ¬Šé™æ¶æ§‹èªªæ˜

## æ¦‚è¿°

æœ¬ç³»çµ±æ¡ç”¨**é›™å±¤æ¬Šé™æ§åˆ¶**æ©Ÿåˆ¶ï¼Œçµåˆã€Œè§’è‰²ã€(role) å’Œã€Œéƒ¨é–€è·ä½ã€(department + job_title) ä¾†å¯¦ç¾éˆæ´»çš„æ¬Šé™ç®¡ç†ã€‚

---

## ä¸€ã€åŸºç¤æ¬Šé™æ¬„ä½

### 1. **è§’è‰² (role)** - ç³»çµ±ç´šåˆ¥æ¬Šé™
å­˜å„²åœ¨ `profiles` è¡¨ä¸­ï¼Œä¸‰å€‹å›ºå®šé¸é …ï¼š

- **`admin`** - ç³»çµ±ç®¡ç†å“¡
  - æœ€é«˜æ¬Šé™
  - å¯ä»¥ç®¡ç†æ‰€æœ‰åŠŸèƒ½
  - å¯ä»¥çœ‹åˆ°æ‰€æœ‰é–€å¸‚å’Œç”¨æˆ¶

- **`manager`** - ä¸»ç®¡
  - ä¸­ç´šæ¬Šé™
  - å¯ä»¥ç®¡ç†ä»»å‹™æµç¨‹
  - å¯ä»¥å¯©æ ¸å’Œç¢ºèªæœˆå ±è¡¨
  - æ ¹æ“šéƒ¨é–€ä¸åŒæœ‰ä¸åŒæ¬Šé™ç¯„åœ

- **`member`** - æˆå“¡
  - åŸºç¤æ¬Šé™
  - å¯ä»¥æŸ¥çœ‹å’ŒåŸ·è¡Œè¢«æŒ‡æ´¾çš„ä»»å‹™
  - æ ¹æ“šéƒ¨é–€ä¸åŒæœ‰ä¸åŒæ¬Šé™ç¯„åœ

### 2. **éƒ¨é–€ (department)** - éƒ¨é–€æ­¸å±¬
å­˜å„²åœ¨ `profiles` è¡¨ä¸­ï¼Œä¾‹å¦‚ï¼š
- `ç‡Ÿæ¥­1éƒ¨`
- `ç‡Ÿæ¥­2éƒ¨`
- `äººè³‡éƒ¨`
- `è²¡å‹™éƒ¨`

### 3. **è·ä½ (job_title)** - å…·é«”è·ç¨±
å­˜å„²åœ¨ `profiles` è¡¨ä¸­ï¼Œä¾‹å¦‚ï¼š
- `ä¸»ç®¡`
- `åŠ©ç†`
- `åº—é•·`
- `ä»£ç†åº—é•·`

### 4. **å“¡å·¥ç·¨è™Ÿ (employee_code)** 
å­˜å„²åœ¨ `profiles` è¡¨ä¸­ï¼Œä¾‹å¦‚ï¼š`FK0171`

---

## äºŒã€çµ„åˆæ¬Šé™é‚è¼¯

### ğŸ” æ¬Šé™çµ„åˆç¤ºä¾‹

#### 1. **ç‡Ÿæ¥­éƒ¨åŠ©ç†**
```typescript
department.startsWith('ç‡Ÿæ¥­') && role === 'member'
```
**æ¬Šé™ç¯„åœï¼š**
- âœ… æŸ¥çœ‹æ‰€æœ‰é–€å¸‚
- âœ… ç®¡ç†é–€å¸‚è³‡æ–™
- âœ… æŸ¥çœ‹æ¯æœˆäººå“¡ç‹€æ…‹
- âŒ ä¸èƒ½åŒ¯å‡ºè³‡æ–™
- âŒ ä¸èƒ½æŒ‡æ´¾åº—é•·
- âŒ ä¸èƒ½ç®¡ç†ç£å°/ç¶“ç†

**æ‡‰ç”¨å ´æ™¯ï¼š**
- ç‡Ÿæ¥­éƒ¨çš„è¡Œæ”¿åŠ©ç†
- éœ€è¦æŸ¥çœ‹å’Œç¶­è­·é–€å¸‚åŸºæœ¬è³‡æ–™

#### 2. **ç‡Ÿæ¥­éƒ¨ä¸»ç®¡ (ç£å°/å€ç¶“ç†)**
```typescript
department.startsWith('ç‡Ÿæ¥­') && role === 'manager'
```
**æ¬Šé™ç¯„åœï¼š**
- âœ… æŸ¥çœ‹æ‰€æœ‰é–€å¸‚
- âœ… ç®¡ç†é–€å¸‚è³‡æ–™
- âœ… æŒ‡æ´¾åº—é•·
- âœ… ç®¡ç†ç£å°/ç¶“ç†
- âœ… æ‰¹æ¬¡åŒ¯å…¥å“¡å·¥
- âœ… æŸ¥çœ‹å’Œå¯©æ ¸æ¯æœˆäººå“¡ç‹€æ…‹
- âœ… åŒ¯å‡ºæœˆå ±è¡¨è³‡æ–™

**æ‡‰ç”¨å ´æ™¯ï¼š**
- ç£å°ã€å€ç¶“ç†
- éœ€è¦å…¨é¢ç®¡ç†ç‡Ÿæ¥­éƒ¨é–€å¸‚

#### 3. **ç³»çµ±ç®¡ç†å“¡**
```typescript
role === 'admin'
```
**æ¬Šé™ç¯„åœï¼š**
- âœ… æ‰€æœ‰åŠŸèƒ½çš„å®Œæ•´æ¬Šé™
- âœ… ç”¨æˆ¶ç®¡ç†
- âœ… ä»»å‹™æµç¨‹ç®¡ç†
- âœ… é–€å¸‚ç®¡ç†
- âœ… æ‰€æœ‰è³‡æ–™çš„åŒ¯å‡º

#### 4. **ä¸€èˆ¬ä¸»ç®¡ï¼ˆéç‡Ÿæ¥­éƒ¨ï¼‰**
```typescript
role === 'manager' && !department.startsWith('ç‡Ÿæ¥­')
```
**æ¬Šé™ç¯„åœï¼š**
- âœ… ç®¡ç†ä»»å‹™æµç¨‹
- âœ… æŸ¥çœ‹å„€è¡¨æ¿
- âœ… æŸ¥çœ‹è¢«æŒ‡æ´¾çš„é–€å¸‚è³‡æ–™
- âŒ ä¸èƒ½æŸ¥çœ‹æ‰€æœ‰é–€å¸‚
- âŒ ä¸èƒ½ç®¡ç†é–€å¸‚è³‡æ–™

#### 5. **åº—é•·/ä»£ç†åº—é•·**
é€é `store_managers` è¡¨é—œè¯
```typescript
job_title IN ('åº—é•·', 'ä»£ç†åº—é•·')
```
**æ¬Šé™ç¯„åœï¼š**
- âœ… ç®¡ç†è‡ªå·±è² è²¬çš„é–€å¸‚
- âœ… å¡«å¯«å’Œæäº¤æ¯æœˆäººå“¡ç‹€æ…‹
- âœ… æŸ¥çœ‹è‡ªå·±é–€å¸‚çš„è³‡æ–™
- âŒ ä¸èƒ½æŸ¥çœ‹å…¶ä»–é–€å¸‚

---

## ä¸‰ã€ä¸»è¦åŠŸèƒ½çš„æ¬Šé™æ§åˆ¶

### ğŸ“‹ ä»»å‹™ç®¡ç†æ¨¡çµ„

| åŠŸèƒ½ | admin | manager | member | ç‡Ÿæ¥­åŠ©ç† | ç‡Ÿæ¥­ä¸»ç®¡ |
|------|-------|---------|--------|----------|----------|
| æˆ‘çš„ä»»å‹™ | âœ… | âœ… | âœ… | âœ… | âœ… |
| å„€è¡¨æ¿ | âœ… | âœ… | âŒ | âŒ | âœ… |
| ä»»å‹™ç®¡ç† | âœ… | âœ… | âŒ | âŒ | âœ… |
| å»ºç«‹ä»»å‹™ | âœ… | âœ… | âŒ | âŒ | âœ… |
| ç·¨è¼¯ä»»å‹™ | âœ… | âœ… | âŒ | âŒ | âœ… |
| æŒ‡æ´¾ä»»å‹™ | âœ… | âœ… | âŒ | âŒ | âœ… |
| å·²å°å­˜ä»»å‹™ | âœ… | âœ… | âŒ | âŒ | âœ… |

### ğŸª é–€å¸‚ç®¡ç†æ¨¡çµ„

| åŠŸèƒ½ | admin | manager | member | ç‡Ÿæ¥­åŠ©ç† | ç‡Ÿæ¥­ä¸»ç®¡ |
|------|-------|---------|--------|----------|----------|
| é–€å¸‚åˆ—è¡¨ | âœ… | âŒ | âŒ | âœ… | âœ… |
| æ–°å¢é–€å¸‚ | âœ… | âŒ | âŒ | âŒ | âœ… |
| ç·¨è¼¯é–€å¸‚ | âœ… | âŒ | âŒ | âœ… | âœ… |
| ç®¡ç†å“¡å·¥ | âœ… | âŒ | âŒ | âœ… | âœ… |
| åº—é•·æŒ‡æ´¾ | âœ… | âŒ | âŒ | âŒ | âœ… |
| ç£å°/ç¶“ç†ç®¡ç† | âœ… | âŒ | âŒ | âŒ | âœ… |
| æ‰¹æ¬¡åŒ¯å…¥å“¡å·¥ | âœ… | âŒ | âŒ | âŒ | âœ… |

### ğŸ“Š æ¯æœˆäººå“¡ç‹€æ…‹æ¨¡çµ„

| åŠŸèƒ½ | admin | ç‡Ÿæ¥­ä¸»ç®¡ | åº—é•· | å…¶ä»– |
|------|-------|----------|------|------|
| æŸ¥çœ‹æ‰€æœ‰é–€å¸‚ç‹€æ…‹ | âœ… | âœ… | âŒ | âŒ |
| æŸ¥çœ‹è‡ªå·±é–€å¸‚ç‹€æ…‹ | âœ… | âœ… | âœ… | âŒ |
| å¡«å¯«å“¡å·¥ç‹€æ…‹ | âœ… | âœ… | âœ… | âŒ |
| æäº¤å¯©æ ¸ | âœ… | âœ… | âœ… | âŒ |
| å¯©æ ¸ç¢ºèª | âœ… | âœ… | âŒ | âŒ |
| åŒ¯å‡ºå ±è¡¨ | âœ… | âœ… | âŒ | âŒ |
| åŒ¯å…¥ç¸¾æ•ˆæ•¸æ“š | âœ… | âœ… | âŒ | âŒ |

---

## å››ã€æ¬Šé™æª¢æŸ¥å¯¦ç¾ä½ç½®

### 1. **Server Actions** (`app/actions.ts`, `app/store/actions.ts`)
```typescript
// æª¢æŸ¥æ˜¯å¦ç‚º admin æˆ– manager
if (!profile || (profile.role !== 'admin' && profile.role !== 'manager')) {
  return { success: false, error: 'æ¬Šé™ä¸è¶³' };
}

// æª¢æŸ¥æ˜¯å¦ç‚ºç‡Ÿæ¥­éƒ¨ä¸»ç®¡
const isBusinessSupervisor = profile?.department?.startsWith('ç‡Ÿæ¥­') && profile?.role === 'manager';
if (!profile || (profile.role !== 'admin' && !isBusinessSupervisor)) {
  return { success: false, error: 'æ¬Šé™ä¸è¶³' };
}
```

### 2. **API Routes** (`app/api/**/route.ts`)
```typescript
// API è·¯ç”±ä¸­çš„æ¬Šé™æª¢æŸ¥
const { data: profile } = await supabase
  .from('profiles')
  .select('role, department, job_title')
  .eq('id', user.id)
  .single();

const isBusinessManager = profile?.department?.startsWith('ç‡Ÿæ¥­') && profile?.role === 'manager';
if (!profile || (profile.role !== 'admin' && !isBusinessManager)) {
  return NextResponse.json({ success: false, error: 'æ¬Šé™ä¸è¶³' }, { status: 403 });
}
```

### 3. **UI çµ„ä»¶** (`components/Navbar.tsx`)
```typescript
// å°èˆªæ¬„æ¬Šé™åˆ¤æ–·
const isBusinessAssistant = user?.profile?.department?.startsWith('ç‡Ÿæ¥­') && user?.profile?.role === 'member';
const isBusinessSupervisor = user?.profile?.department?.startsWith('ç‡Ÿæ¥­') && user?.profile?.role === 'manager';

// æ ¹æ“šæ¬Šé™é¡¯ç¤ºä¸åŒé¸å–®
const storeSubItems = [
  { href: '/admin/stores', label: 'é–€å¸‚ç®¡ç†', roles: ['admin'], 
    allowBusinessAssistant: true, allowBusinessSupervisor: true }
].filter(item => 
  item.roles.includes(role) || 
  (item.allowBusinessAssistant && isBusinessAssistant) ||
  (item.allowBusinessSupervisor && isBusinessSupervisor)
);
```

### 4. **é é¢çµ„ä»¶** (`app/**/page.tsx`)
```typescript
// é é¢ç´šåˆ¥çš„æ¬Šé™æª¢æŸ¥
const { data: profile } = await supabase
  .from('profiles')
  .select('role, department, job_title')
  .eq('id', user.id)
  .single();

const isBusinessAssistant = profile?.department?.startsWith('ç‡Ÿæ¥­') && profile?.role === 'member';
const isBusinessSupervisor = profile?.department?.startsWith('ç‡Ÿæ¥­') && profile?.role === 'manager';

if (!profile || (profile.role !== 'admin' && !isBusinessAssistant && !isBusinessSupervisor)) {
  redirect('/');
}
```

---

## äº”ã€è³‡æ–™åº«æ¬Šé™ï¼ˆRLS - Row Level Securityï¼‰

Supabase çš„ RLS ç­–ç•¥æ ¹æ“šç”¨æˆ¶è§’è‰²å’Œé–€å¸‚é—œè¯æ§åˆ¶æ•¸æ“šè¨ªå•ï¼š

### ç¯„ä¾‹ç­–ç•¥

```sql
-- profiles è¡¨ï¼šç”¨æˆ¶åªèƒ½çœ‹åˆ°è‡ªå·±çš„è³‡æ–™ï¼Œadmin å¯ä»¥çœ‹æ‰€æœ‰
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Admins can view all profiles"
  ON profiles FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- stores è¡¨ï¼šç‡Ÿæ¥­éƒ¨äººå“¡å¯ä»¥çœ‹æ‰€æœ‰é–€å¸‚
CREATE POLICY "Business dept can view all stores"
  ON stores FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid() 
      AND department LIKE 'ç‡Ÿæ¥­%'
    )
  );

-- store_managers è¡¨ï¼šç®¡ç†é–€å¸‚é—œè¯
CREATE POLICY "Users can view their managed stores"
  ON store_managers FOR SELECT
  USING (user_id = auth.uid());
```

---

## å…­ã€å¸¸è¦‹æ¬Šé™å ´æ™¯

### å ´æ™¯ 1: æ–°å¢ç‡Ÿæ¥­éƒ¨åŠ©ç†
```sql
INSERT INTO profiles (id, email, full_name, role, department, job_title)
VALUES (
  'user-uuid',
  'assistant@example.com',
  'å¼µåŠ©ç†',
  'member',        -- è§’è‰²ï¼šæˆå“¡
  'ç‡Ÿæ¥­1éƒ¨',       -- éƒ¨é–€ï¼šç‡Ÿæ¥­1éƒ¨
  'åŠ©ç†'           -- è·ä½ï¼šåŠ©ç†
);
```
**çµæœï¼š** å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰é–€å¸‚ï¼Œä½†ä¸èƒ½åŒ¯å‡ºè³‡æ–™æˆ–æŒ‡æ´¾äººå“¡

### å ´æ™¯ 2: æ–°å¢å€ç¶“ç†
```sql
INSERT INTO profiles (id, email, full_name, role, department, job_title)
VALUES (
  'user-uuid',
  'manager@example.com',
  'ç‹ç¶“ç†',
  'manager',       -- è§’è‰²ï¼šä¸»ç®¡
  'ç‡Ÿæ¥­2éƒ¨',       -- éƒ¨é–€ï¼šç‡Ÿæ¥­2éƒ¨
  'å€ç¶“ç†'         -- è·ä½ï¼šå€ç¶“ç†
);
```
**çµæœï¼š** æ“æœ‰é–€å¸‚ç®¡ç†çš„æ‰€æœ‰æ¬Šé™ï¼ŒåŒ…æ‹¬æŒ‡æ´¾åº—é•·ã€åŒ¯å‡ºè³‡æ–™ç­‰

### å ´æ™¯ 3: æ–°å¢åº—é•·
```sql
-- 1. å…ˆåœ¨ profiles å»ºç«‹ç”¨æˆ¶
INSERT INTO profiles (id, email, full_name, role, department, job_title)
VALUES (
  'user-uuid',
  'storemanager@example.com',
  'æåº—é•·',
  'member',        -- è§’è‰²ï¼šæˆå“¡
  NULL,            -- éƒ¨é–€ï¼šå¯ç‚ºç©º
  'åº—é•·'           -- è·ä½ï¼šåº—é•·
);

-- 2. åœ¨ store_managers å»ºç«‹é–€å¸‚é—œè¯
INSERT INTO store_managers (user_id, store_id)
VALUES ('user-uuid', 'store-uuid');
```
**çµæœï¼š** åªèƒ½ç®¡ç†è¢«æŒ‡æ´¾çš„é–€å¸‚ï¼Œå¡«å¯«è©²é–€å¸‚çš„æ¯æœˆç‹€æ…‹

---

## ä¸ƒã€æ¬Šé™æ“´å±•å»ºè­°

å¦‚éœ€æ–°å¢æ›´ç´°ç·»çš„æ¬Šé™æ§åˆ¶ï¼Œå¯è€ƒæ…®ï¼š

1. **åŠŸèƒ½ç´šåˆ¥æ¬Šé™è¡¨**
   - å»ºç«‹ `permissions` è¡¨å®šç¾©å…·é«”åŠŸèƒ½æ¬Šé™
   - å»ºç«‹ `role_permissions` é—œè¯è§’è‰²å’Œæ¬Šé™

2. **å€åŸŸé™åˆ¶**
   - æ·»åŠ  `region` æ¬„ä½é™åˆ¶æŸ¥çœ‹ç¯„åœ
   - ä¾‹å¦‚ï¼šåŒ—å€ã€å—å€ç£å°åªèƒ½çœ‹å„è‡ªå€åŸŸ

3. **æ™‚é–“é™åˆ¶**
   - æ·»åŠ æ¬Šé™æœ‰æ•ˆæœŸ
   - ä¾‹å¦‚ï¼šè‡¨æ™‚æˆæ¬Šåªåœ¨ç‰¹å®šæ™‚é–“æœ‰æ•ˆ

4. **å¯©è¨ˆæ—¥èªŒ**
   - è¨˜éŒ„æ‰€æœ‰æ¬Šé™æ•æ„Ÿæ“ä½œ
   - è¿½è¹¤èª°åœ¨ä½•æ™‚åšäº†ä»€éº¼

---

## å…«ã€æ¬Šé™æ¸¬è©¦æ¸…å–®

åœ¨ä¿®æ”¹æ¬Šé™ç›¸é—œä»£ç¢¼å¾Œï¼Œæ‡‰æ¸¬è©¦ï¼š

- [ ] Admin å¯ä»¥è¨ªå•æ‰€æœ‰åŠŸèƒ½
- [ ] ç‡Ÿæ¥­éƒ¨ä¸»ç®¡å¯ä»¥ç®¡ç†é–€å¸‚å’ŒåŒ¯å‡ºè³‡æ–™
- [ ] ç‡Ÿæ¥­éƒ¨åŠ©ç†å¯ä»¥æŸ¥çœ‹é–€å¸‚ä½†ä¸èƒ½åŒ¯å‡º
- [ ] ä¸€èˆ¬ä¸»ç®¡åªèƒ½çœ‹åˆ°è¢«æŒ‡æ´¾çš„ä»»å‹™
- [ ] åº—é•·åªèƒ½ç®¡ç†è‡ªå·±çš„é–€å¸‚
- [ ] ä¸€èˆ¬æˆå“¡åªèƒ½çœ‹åˆ°è‡ªå·±çš„ä»»å‹™
- [ ] æœªç™»å…¥ç”¨æˆ¶è¢«é‡å®šå‘åˆ°ç™»å…¥é 
- [ ] RLS ç­–ç•¥æ­£ç¢ºé™åˆ¶æ•¸æ“šè¨ªå•

---

## ç¸½çµ

æœ¬ç³»çµ±çš„æ¬Šé™è¨­è¨ˆç‰¹é»ï¼š

1. **éˆæ´»æ€§**ï¼šrole + department + job_title çµ„åˆå¯ä»¥å¯¦ç¾å¤šç¨®æ¬Šé™å ´æ™¯
2. **å®‰å…¨æ€§**ï¼šå¤šå±¤æª¢æŸ¥ï¼ˆUIã€Server Actionsã€APIã€RLSï¼‰
3. **å¯æ“´å±•æ€§**ï¼šå®¹æ˜“æ·»åŠ æ–°çš„æ¬Šé™çµ„åˆ
4. **æ¸…æ™°æ€§**ï¼šæ¬Šé™é‚è¼¯é›†ä¸­ä¸”æ˜“æ–¼ç†è§£

**é—œéµåŸå‰‡ï¼š**
- `role` æ±ºå®šç³»çµ±ç´šåˆ¥æ¬Šé™
- `department` æ±ºå®šæ¥­å‹™ç¯„åœ
- `job_title` æä¾›é¡å¤–è·ä½è³‡è¨Š
- çµ„åˆä½¿ç”¨å¯¦ç¾ç´°ç·»æ¬Šé™æ§åˆ¶
