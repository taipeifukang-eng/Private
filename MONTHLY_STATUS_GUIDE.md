# 每月人員狀態確認功能 - 使用指南

## 功能概述

此功能模組是「富康內部業務管理系統」的新增功能，用於管理每月人員狀態，以支援獎金計算系統。

## 資料庫設置

在使用此功能前，請先執行資料庫遷移：

1. 登入 Supabase Dashboard
2. 進入 SQL Editor
3. 執行 `supabase/migration_monthly_staff_status.sql` 中的 SQL 語句

## 權限層級 (RBAC)

### 1. 管理員 (admin)
- 可查看所有門市
- 可新增/編輯門市資訊
- 可指派門市管理者
- 可確認所有門市的人員狀態
- 可匯出所有資料

### 2. 督導/區經理 (supervisor/area_manager)
- 可查看被指派管理的門市
- 可確認已提交的門市狀態
- 可匯出已確認的資料

### 3. 店長 (store_manager)
- 只能查看自己負責的門市
- 可編輯門市員工的每月狀態
- 可提交狀態審核（提交後無法修改）

### 4. 一般成員 (member)
- 可查看自己的狀態記錄

## 獎金計算區塊對應

系統會根據填寫的資訊自動計算員工屬於哪個獎金區塊：

| 區塊 | 代表人員 | 計算特色 |
|------|----------|----------|
| 區塊 1 | 正職整月在職 | 達標領全額、未達標按比例 |
| 區塊 2 | 督導卡班 | Bonus = 0 |
| 區塊 3 | 非整月正職 | 按天數比例計算 |
| 區塊 4 | 特殊時數 | 督導(代理店長)-雙等特殊規則 |
| 區塊 5 | 兼職藥師 | 按時數/160比例計算 |
| 區塊 6 | 兼職一般人 | Bonus = 0 |

## 操作流程

### 店長操作流程

1. **初始化資料**
   - 進入「每月人員狀態」頁面
   - 選擇年月
   - 點擊「初始化本月資料」

2. **填寫員工狀態**
   - 點擊員工列表中的「編輯」
   - 填寫：
     - 職位
     - 本月狀態（整月在職/到職/離職等）
     - 工作天數或時數
     - 特殊標記（雙職務/店長加成/督導卡班）
   - 系統會自動顯示計算的區塊

3. **提交審核**
   - 確認所有員工資料填寫完畢
   - 點擊「送出審核」
   - 提交後無法再修改

### 督導/經理操作流程

1. **查看門市狀態**
   - 進入「每月人員狀態」頁面
   - 使用門市標籤切換查看各門市

2. **確認審核**
   - 檢視已提交的門市資料
   - 確認無誤後點擊「確認審核」

3. **匯出資料**
   - 確認完成後可點擊「匯出 Excel」
   - 檔案可用於獎金計算

## 匯出格式

匯出的 CSV 檔案包含以下欄位：

- 門市代碼
- 門市名稱
- 員工代號
- 員工姓名
- 職位
- 雇用類型
- 是否藥師
- 本月狀態
- 工作天數
- 本月總天數
- 工作時數
- 是否雙職務
- 店長加成資格
- 督導卡班
- 計算區塊
- 備註

## 自動判定邏輯

系統會根據以下規則自動判定獎金區塊：

```
if (督導卡班) → 區塊 2
if (兼職 && 非藥師) → 區塊 6
if (兼職 && 藥師) → 區塊 5
if (督導(代理店長) && 雙職務) → 區塊 4
if (正職 && 非整月在職) → 區塊 3
if (店長/代理店長 && 雙職務) → 區塊 3
if (正職 && 整月在職) → 區塊 1
```

## 注意事項

1. **每月需重新初始化**
   - 每個月的資料是獨立的
   - 需要在每月初點擊「初始化本月資料」

2. **提交後不可修改**
   - 店長提交審核後，只有重新建立才能修改
   - 請確認無誤後再提交

3. **確認後才能匯出**
   - 只有督導/經理確認後的資料才能匯出
   - 確保資料經過審核

## 相關檔案

- 資料庫遷移：`supabase/migration_monthly_staff_status.sql`
- 類型定義：`types/workflow.ts`
- Server Actions：`app/store/actions.ts`
- 主頁面：`app/monthly-status/page.tsx`
- 編輯頁面：`app/monthly-status/edit/[id]/page.tsx`
- 門市管理：`app/admin/stores/page.tsx`
